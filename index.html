<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect Ultra - Secured Communication</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        :root { --primary: #075e54; --accent: #25d366; --bg: #ece5dd; --error: #ff3b30; --white: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Layouts */
        #auth-screen, #main-screen, #chat-screen, #call-overlay { display: none; height: 100%; flex-direction: column; }
        .header { background: var(--primary); color: var(--white); padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        
        /* Cards & UI */
        .card { background: var(--white); padding: 25px; border-radius: 15px; margin: auto; width: 85%; max-width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); text-align: center; }
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-success { background: var(--accent); color: var(--white); }
        
        /* Chat & Call */
        .msg-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: #e5ddd5; }
        .msg { padding: 8px 12px; border-radius: 10px; max-width: 70%; font-size: 14px; position: relative; }
        .sent { background: #dcf8c6; align-self: flex-end; }
        .received { background: white; align-self: flex-start; }
        
        #video-grid { flex: 1; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 5px; background: #000; padding: 5px; }
        video { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; background: #222; }
        
        .loader { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 200; align-items: center; justify-content: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Admin Controls */
        .admin-item { background: white; margin: 5px 15px; padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>
    <audio id="ringtone" loop src="https://www.soundjay.com/phone/phone-calling-1.mp3"></audio>

    <div id="auth-screen" style="display: flex;">
        <div class="card" id="login-box">
            <h2 style="color: var(--primary)">Connect Ultra</h2>
            <div style="display: flex; gap: 5px;">
                <select id="login-country" style="width: 40%;"></select>
                <input type="tel" id="login-id" placeholder="Mobile ID" style="flex:1;">
            </div>
            <input type="password" id="login-pass" placeholder="Password">
            <button class="btn btn-success" onclick="handleLogin()">Login</button>
            <p onclick="toggleAuth(false)" style="color: var(--primary); cursor: pointer; font-size: 14px;">Register New Account</p>
        </div>
        <div class="card" id="reg-box" style="display: none;">
            <div class="loader" id="reg-loader"><div class="spinner"></div><p>Submitting...</p></div>
            <h2 style="color: var(--primary)">Register</h2>
            <input type="text" id="reg-name" placeholder="Full Name">
            <div style="display: flex; gap: 5px;">
                <select id="reg-country" style="width: 40%;"></select>
                <input type="tel" id="reg-id" placeholder="Mobile ID" style="flex:1;">
            </div>
            <input type="email" id="reg-mail" placeholder="Mail ID">
            <input type="password" id="reg-pass" placeholder="Password">
            <button class="btn btn-success" onclick="requestAccess()">Submit for Approval</button>
            <p onclick="toggleAuth(true)" style="color: var(--primary); cursor: pointer; font-size: 14px;">Back to Login</p>
        </div>
    </div>

    <div id="main-screen">
        <div class="header">
            <div>Connect</div>
            <div style="position: relative; cursor: pointer;" onclick="toggleDrop()">
                <span id="u-name">User</span>
                <div class="dropdown" id="drop-menu" style="display:none; position:absolute; right:0; top:35px; background:white; color:black; width:180px; box-shadow:0 5px 15px rgba(0,0,0,0.2); border-radius:8px; overflow:hidden;">
                    <button style="width:100%; text-align:left; padding:12px; border:none; background:none;" onclick="showProfile()">Profile Settings</button>
                    <div id="admin-only" style="display:none;">
                        <button style="width:100%; text-align:left; padding:12px; border:none; background:none; color:var(--error);" onclick="manageUsers()">Remove Existing User</button>
                    </div>
                    <button style="width:100%; text-align:left; padding:12px; border:none; background:none;" onclick="logout()">Sign Out</button>
                </div>
            </div>
        </div>
        <div id="contact-list" style="overflow-y:auto; flex:1;"></div>
    </div>

    <div id="chat-screen">
        <div class="header">
            <button onclick="backToMain()" style="background:none; border:none; color:white; font-size:20px;">‚Üê</button>
            <div id="chat-with" style="flex:1; margin-left:10px;">User</div>
            <button onclick="makeCall('voice')" style="background:none; border:none; color:white; margin-right:15px;">üìû</button>
            <button onclick="makeCall('video')" style="background:none; border:none; color:white;">üìπ</button>
        </div>
        <div class="msg-area" id="msg-area"></div>
        <div style="padding:10px; display:flex; background:white; gap:5px;">
            <input type="text" id="msg-input" placeholder="Type message..." style="margin:0;">
            <button onclick="sendMsg()" style="background:var(--primary); color:white; border:none; padding:10px 15px; border-radius:5px;">Send</button>
        </div>
    </div>

    <div id="call-overlay">
        <div id="video-grid"></div>
        <div style="height:80px; display:flex; justify-content:center; align-items:center; gap:30px; background:#000;">
            <button onclick="endCall()" style="background:var(--error); width:50px; height:50px; border-radius:50%; border:none; color:white;">End</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAIowb628afMgDxbAqyoHVpXRfSC_mTL2g",
            databaseURL: "https://fefei-8f083-default-rtdb.firebaseio.com",
            projectId: "fefei-8f083"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        emailjs.init("9ynLrm-41NbPpvJPG");

        let peer, localStream, currentCall, myId, myData, chatTarget;
        const hash = (p) => btoa(p);
        const ADMIN_ID = "+919539677432";

        const countries = [
            {n: "India", c: "+91"}, {n: "Saudi Arabia", c: "+966"}, {n: "UAE", c: "+971"}, 
            {n: "USA", c: "+1"}, {n: "UK", c: "+44"}, {n: "Oman", c: "+968"}
            // ‡¥Æ‡¥±‡µç‡¥±‡µç ‡¥∞‡¥æ‡¥ú‡µç‡¥Ø‡¥ô‡µç‡¥ô‡µæ ‡¥§‡¥®‡¥ø‡¥Ø‡µÜ ‡¥Ü‡¥°‡µç ‡¥Ü‡¥ï‡µÅ‡¥Ç
        ];

        window.onload = () => {
            loadCountries();
            checkAdmin();
            const saved = localStorage.getItem('session');
            if (saved) startApp(JSON.parse(saved));
        };

        function loadCountries() {
            const selects = [document.getElementById('login-country'), document.getElementById('reg-country')];
            selects.forEach(s => {
                countries.forEach(cnt => {
                    let opt = new Array(`<option value="${cnt.c}">${cnt.n} (${cnt.c})</option>`);
                    s.innerHTML += opt;
                });
            });
        }

        function toggleAuth(isLogin) {
            document.getElementById('login-box').style.display = isLogin ? 'block' : 'none';
            document.getElementById('reg-box').style.display = isLogin ? 'none' : 'block';
        }

        function requestAccess() {
            const n = document.getElementById('reg-name').value;
            const id = document.getElementById('reg-country').value + document.getElementById('reg-id').value;
            const m = document.getElementById('reg-mail').value;
            const p = hash(document.getElementById('reg-pass').value);

            if(!n || !id || !m || !p) return alert("Fields required");

            db.ref('users/' + id).once('value', snap => {
                if (snap.exists()) return alert("Mobile ID already registered!");
                
                document.getElementById('reg-loader').style.display = 'flex';
                emailjs.send("service_8exfr9s", "template_8yx5s1k", { from_name: n, user_id: id, user_email: m }).then(() => {
                    db.ref('pending_users/' + id).set({ name: n, id: id, mail: m, pass: p });
                    alert("Request sent to Admin!");
                    location.reload();
                });
            });
        }

        function handleLogin() {
            const id = document.getElementById('login-country').value + document.getElementById('login-id').value;
            const p = hash(document.getElementById('login-pass').value);

            db.ref('users/' + id).once('value', snap => {
                if (snap.exists() && snap.val().pass === p) {
                    localStorage.setItem('session', JSON.stringify(snap.val()));
                    startApp(snap.val());
                } else alert("Invalid ID/Password or Approval Pending");
            });
        }

        function startApp(user) {
            myId = user.id; myData = user;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-screen').style.display = 'flex';
            document.getElementById('u-name').innerText = user.name;
            if(myId === ADMIN_ID) document.getElementById('admin-only').style.display = 'block';

            peer = new Peer(myId.replace('+', ''));
            peer.on('open', () => {
                db.ref('users/' + myId).update({ online: true });
                loadUsers();
            });

            peer.on('call', call => {
                if(confirm("Incoming call from " + call.peer + ". Accept?")) {
                    currentCall = call;
                    acceptCall();
                }
            });
        }

        function loadUsers() {
            db.ref('users').on('value', snap => {
                const list = document.getElementById('contact-list'); list.innerHTML = '';
                snap.forEach(c => {
                    if (c.key !== myId) {
                        const u = c.val();
                        const div = document.createElement('div');
                        div.style = "padding:15px; background:white; border-bottom:1px solid #eee; cursor:pointer;";
                        div.innerHTML = `<b>${u.name}</b><br><small>${u.id}</small>`;
                        div.onclick = () => openChat(u);
                        list.appendChild(div);
                    }
                });
            });
        }

        function openChat(user) {
            chatTarget = user;
            document.getElementById('main-screen').style.display = 'none';
            document.getElementById('chat-screen').style.display = 'flex';
            document.getElementById('chat-with').innerText = user.name;
            // ‡¥≤‡µã‡¥ó‡¥ø‡¥ï‡µç ‡¥´‡µã‡µº ‡¥ö‡¥æ‡¥±‡µç‡¥±‡µç ‡¥≤‡µã‡¥°‡¥ø‡¥Ç‡¥ó‡µç...
        }

        async function makeCall(type) {
            document.getElementById('call-overlay').style.display = 'flex';
            localStream = await navigator.mediaDevices.getUserMedia({video: type==='video', audio: true});
            addVideoStream(document.createElement('video'), localStream, true);
            const call = peer.call(chatTarget.id.replace('+', ''), localStream);
            call.on('stream', s => addVideoStream(document.createElement('video'), s));
        }

        function addVideoStream(video, stream, muted = false) {
            video.srcObject = stream;
            if(muted) video.muted = true;
            video.addEventListener('loadedmetadata', () => video.play());
            document.getElementById('video-grid').append(video);
        }

        function endCall() {
            location.reload();
        }

        function manageUsers() {
            const list = document.getElementById('contact-list');
            list.innerHTML = '<h3 style="padding:15px;">Admin: User Management</h3>';
            db.ref('users').once('value', snap => {
                snap.forEach(c => {
                    const u = c.val();
                    const div = document.createElement('div');
                    div.className = 'admin-item';
                    div.innerHTML = `<span>${u.name} (${u.id})</span> <button onclick="removeUser('${u.id}')" style="background:red; color:white; border:none; padding:5px 10px; border-radius:5px;">Remove</button>`;
                    list.appendChild(div);
                });
            });
        }

        function removeUser(uid) {
            if(confirm("Remove this user permanently?")) {
                db.ref('users/' + uid).remove();
                manageUsers();
            }
        }

        function checkAdmin() {
            const p = new URLSearchParams(window.location.search);
            if(p.get('action') === 'approve' && p.get('id')) {
                db.ref('pending_users/' + p.get('id')).once('value', snap => {
                    if(snap.exists()) {
                        db.ref('users/' + p.get('id')).set(snap.val()).then(() => {
                            db.ref('pending_users/' + p.get('id')).remove();
                            alert("User Approved!");
                        });
                    }
                });
            }
        }

        function toggleDrop() {
            const m = document.getElementById('drop-menu');
            m.style.display = m.style.display === 'none' ? 'block' : 'none';
        }

        function showProfile() {
            const n = prompt("Change Name:", myData.name);
            const p = prompt("New Password (Leave blank to keep same):");
            let update = {};
            if(n) update.name = n;
            if(p) update.pass = hash(p);
            db.ref('users/' + myId).update(update).then(() => location.reload());
        }

        function logout() { localStorage.clear(); location.reload(); }
        function backToMain() { location.reload(); }
    </script>
</body>
</html>
