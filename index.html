<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect - Private Video Call</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root { --whatsapp-green: #075e54; --light-green: #25d366; --bg-gray: #ece5dd; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-gray); margin: 0; overflow-x: hidden; }
        
        /* Layouts */
        #auth-screen, #main-screen { display: none; height: 100vh; flex-direction: column; }
        .header { background: var(--whatsapp-green); color: white; padding: 15px; font-size: 20px; font-weight: bold; position: sticky; top: 0; z-index: 10; display: flex; justify-content: space-between; }
        
        /* Contact List */
        .contact-item { background: white; padding: 15px; border-bottom: 1px solid #ddd; display: flex; align-items: center; cursor: pointer; }
        .contact-item:hover { background: #f5f5f5; }
        .avatar { width: 50px; height: 50px; background: #ccc; border-radius: 50%; margin-right: 15px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; margin-left: auto; }
        .online { background: var(--light-green); }
        .offline { background: #bbb; }

        /* Video Call Overlay */
        #call-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 100; flex-direction: column; }
        .video-container { flex: 1; position: relative; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { width: 120px; height: 160px; position: absolute; top: 20px; right: 20px; border-radius: 10px; border: 2px solid white; object-fit: cover; }
        .call-controls { height: 100px; display: flex; justify-content: center; align-items: center; gap: 30px; background: rgba(0,0,0,0.5); }
        .btn-round { width: 60px; height: 60px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; }
        .btn-end { background: #ff3b30; }
        .btn-accept { background: #4cd964; }

        /* Auth Card */
        .auth-card { background: white; padding: 30px; border-radius: 15px; margin: auto; width: 85%; max-width: 350px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: center; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn-primary { background: var(--light-green); color: white; border: none; padding: 12px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <audio id="ringtone" loop src="https://www.soundjay.com/phone/phone-calling-1.mp3"></audio>

    <div id="auth-screen">
        <div class="auth-card">
            <h2 style="color: var(--whatsapp-green)">Connect</h2>
            <input type="text" id="username" placeholder="നിങ്ങളുടെ പേര്">
            <input type="tel" id="phone" placeholder="മൊബൈൽ നമ്പർ (With Country Code)">
            <button class="btn-primary" onclick="handleLogin()">തുടങ്ങാം</button>
        </div>
    </div>

    <div id="main-screen">
        <div class="header">
            <span>Connect</span>
            <span style="font-size: 14px; opacity: 0.8;" id="my-num"></span>
        </div>
        <div style="padding: 10px; font-size: 14px; color: #666;">നിങ്ങളുടെ കോൺടാക്റ്റുകൾ</div>
        <div id="contact-list">
            <p style="text-align: center; margin-top: 20px;">കോൺടാക്റ്റുകൾ തിരയുന്നു...</p>
        </div>
    </div>

    <div id="call-overlay">
        <div class="video-container">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay muted playsinline></video>
        </div>
        <div class="call-controls" id="call-ui-controls">
            </div>
    </div>

    <script>
        // --- FIREBASE CONFIG (ഇവിടെ നിന്റെ സ്വന്തം കീ നൽകണം) ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            databaseURL: "https://YOUR_PROJECT.firebaseio.com",
            projectId: "YOUR_PROJECT",
            appId: "YOUR_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let peer, localStream, currentCall, myPhone;
        const ringtone = document.getElementById('ringtone');

        window.onload = () => {
            const saved = localStorage.getItem('user_data');
            if (saved) {
                const data = JSON.parse(saved);
                document.getElementById('username').value = data.name;
                document.getElementById('phone').value = data.phone;
                handleLogin();
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
            }
        };

        async function handleLogin() {
            const name = document.getElementById('username').value;
            myPhone = document.getElementById('phone').value;
            if (!name || !myPhone) return alert("വിവരങ്ങൾ നൽകുക");

            localStorage.setItem('user_data', JSON.stringify({name, phone: myPhone}));
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-screen').style.display = 'flex';
            document.getElementById('my-num').innerText = myPhone;

            peer = new Peer(myPhone);

            peer.on('open', (id) => {
                db.ref('users/' + myPhone).set({ name, status: 'online', lastSeen: Date.now() });
                syncContacts();
            });

            peer.on('call', (call) => {
                currentCall = call;
                showCallUI('incoming', call.peer);
            });

            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('local-video').srcObject = localStream;
        }

        // --- കോൺടാക്റ്റ് സിൻക് (Contact Sync) ---
        async function syncContacts() {
            if ('contacts' in navigator && 'ContactsManager' in window) {
                try {
                    const props = ['name', 'tel'];
                    const contacts = await navigator.contacts.select(props, { multiple: true });
                    processContacts(contacts);
                } catch (err) {
                    console.log("Contact API error, using manual sync");
                    loadAllRegisteredUsers(); // പെർമിഷൻ ഇല്ലെങ്കിൽ എല്ലാവരെയും കാണിക്കാം (പരീക്ഷണത്തിന്)
                }
            } else {
                loadAllRegisteredUsers();
            }
        }

        function loadAllRegisteredUsers() {
            db.ref('users').on('value', (snapshot) => {
                const list = document.getElementById('contact-list');
                list.innerHTML = '';
                snapshot.forEach((child) => {
                    if (child.key !== myPhone) {
                        const user = child.val();
                        addContactToUI(user.name, child.key, user.status);
                    }
                });
            });
        }

        function addContactToUI(name, phone, status) {
            const div = document.createElement('div');
            div.className = 'contact-item';
            div.onclick = () => startCall(phone);
            div.innerHTML = `
                <div class="avatar">${name.charAt(0)}</div>
                <div>
                    <div style="font-weight:bold">${name}</div>
                    <div style="font-size:12px; color:#777">${phone}</div>
                </div>
                <div class="status-dot ${status === 'online' ? 'online' : 'offline'}"></div>
            `;
            document.getElementById('contact-list').appendChild(div);
        }

        // --- കോളിംഗ് ഫീച്ചറുകൾ ---
        function startCall(targetPhone) {
            showCallUI('outgoing', targetPhone);
            const call = peer.call(targetPhone, localStream);
            setupCallEvents(call);
        }

        function showCallUI(type, peerId) {
            document.getElementById('call-overlay').style.display = 'flex';
            const controls = document.getElementById('call-ui-controls');
            if (type === 'incoming') {
                ringtone.play();
                controls.innerHTML = `
                    <button class="btn-round btn-accept" onclick="answerCall()">Accept</button>
                    <button class="btn-round btn-end" onclick="endCall()">Reject</button>
                `;
            } else {
                controls.innerHTML = `<button class="btn-round btn-end" onclick="endCall()">End Call</button>`;
            }
        }

        function answerCall() {
            ringtone.pause();
            currentCall.answer(localStream);
            setupCallEvents(currentCall);
        }

        function setupCallEvents(call) {
            currentCall = call;
            call.on('stream', (stream) => {
                document.getElementById('remote-video').srcObject = stream;
            });
            call.on('close', endCall);
        }

        function endCall() {
            ringtone.pause();
            if (currentCall) currentCall.close();
            document.getElementById('call-overlay').style.display = 'none';
            document.getElementById('remote-video').srcObject = null;
        }
    </script>
</body>
</html>
