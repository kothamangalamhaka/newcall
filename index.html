<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect - Global Video Call</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root { --whatsapp-green: #075e54; --light-green: #25d366; --bg-gray: #ece5dd; --danger: #ff3b30; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-gray); margin: 0; overflow-x: hidden; }
        #auth-screen, #main-screen { display: none; height: 100vh; flex-direction: column; }
        .header { background: var(--whatsapp-green); color: white; padding: 12px 15px; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; }
        .user-profile { position: relative; cursor: pointer; display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 20px; }
        .profile-dropdown { display: none; position: absolute; top: 45px; right: 0; background: white; color: black; min-width: 180px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 101; }
        .profile-dropdown button { width: 100%; text-align: left; padding: 12px 15px; border: none; background: none; cursor: pointer; border-bottom: 1px solid #eee; }
        .contact-item { background: white; padding: 15px; border-bottom: 1px solid #ddd; display: flex; align-items: center; cursor: pointer; }
        .avatar { width: 45px; height: 45px; background: #075e54; border-radius: 50%; margin-right: 15px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; margin-left: auto; }
        .online { background: var(--light-green); }
        .offline { background: #bbb; }
        #call-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 200; flex-direction: column; }
        .video-container { flex: 1; position: relative; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { width: 100px; height: 140px; position: absolute; top: 20px; right: 20px; border-radius: 10px; border: 2px solid white; object-fit: cover; }
        .call-controls { height: 100px; display: flex; justify-content: center; align-items: center; gap: 30px; background: rgba(0,0,0,0.5); }
        .btn-round { width: 60px; height: 60px; border-radius: 50%; border: none; cursor: pointer; color: white; font-size: 20px; }
        .auth-card { background: white; padding: 30px; border-radius: 15px; margin: auto; width: 85%; max-width: 380px; text-align: center; }
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 8px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        .btn-primary { background: var(--light-green); color: white; border: none; padding: 12px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <audio id="ringtone" loop src="https://www.soundjay.com/phone/phone-calling-1.mp3"></audio>

    <div id="auth-screen">
        <div class="auth-card">
            <h2 style="color: var(--whatsapp-green)">Connect</h2>
            
            <div id="step-phone">
                <select id="country-code" style="width: 100%;">
                    <option value="+966">ðŸ‡¸ðŸ‡¦ Saudi Arabia (+966)</option>
                    <option value="+91">ðŸ‡®ðŸ‡³ India (+91)</option>
                    <option value="+971">ðŸ‡¦ðŸ‡ª UAE (+971)</option>
                    <option value="+968">ðŸ‡´ðŸ‡² Oman (+968)</option>
                    <option value="+974">ðŸ‡¶ðŸ‡¦ Qatar (+974)</option>
                    <option value="+973">ðŸ‡§ðŸ‡­ Bahrain (+973)</option>
                    <option value="+44">ðŸ‡¬ðŸ‡§ UK (+44)</option>
                    <option value="+1">ðŸ‡ºðŸ‡¸ USA (+1)</option>
                    <option value="+965">ðŸ‡°ðŸ‡¼ Kuwait (+965)</option>
                </select>
                <input type="tel" id="phone-input" placeholder="Mobile Number" inputmode="numeric" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                <div id="recaptcha-container"></div>
                <button class="btn-primary" onclick="sendOTP()">Send OTP</button>
            </div>

            <div id="step-otp" style="display:none;">
                <input type="text" id="otp-input" placeholder="Enter OTP" inputmode="numeric">
                <button class="btn-primary" onclick="verifyOTP()">Verify OTP</button>
            </div>

            <div id="step-name" style="display:none;">
                <input type="text" id="username-input" placeholder="Choose Unique Username">
                <button class="btn-primary" onclick="registerUser()">Start Now</button>
            </div>
        </div>
    </div>

    <div id="main-screen">
        <div class="header">
            <div class="logo">Connect</div>
            <div class="user-profile" onclick="toggleDropdown()">
                <span id="display-name">User</span>
                <div class="profile-dropdown" id="profile-menu">
                    <div id="display-id" style="padding:10px; font-size:12px; color:#666;">ID: ---</div>
                    <button onclick="editProfile()">Edit Name</button>
                    <button onclick="logout()" style="color:var(--danger)">Logout</button>
                </div>
            </div>
        </div>
        <div style="padding: 15px; background: white; border-bottom: 1px solid #ddd;">
            <div style="display:flex; gap:10px;">
                <input type="tel" id="dial-number" placeholder="Enter ID to Call..." style="flex:1; margin:0;" inputmode="numeric">
                <button onclick="dialCall()" style="background:var(--light-green); border:none; padding:10px 20px; border-radius:8px; color:white; font-weight:bold;">Call</button>
            </div>
        </div>
        <div style="padding: 10px; font-size: 14px; font-weight: bold;">Contacts</div>
        <div id="contact-list"></div>
    </div>

    <div id="call-overlay">
        <div class="video-container">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay muted playsinline></video>
        </div>
        <div class="call-controls" id="call-ui-controls"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAIowb628afMgDxbAqyoHVpXRfSC_mTL2g",
            authDomain: "fefei-8f083.firebaseapp.com",
            databaseURL: "https://fefei-8f083-default-rtdb.firebaseio.com",
            projectId: "fefei-8f083",
            storageBucket: "fefei-8f083.firebasestorage.app",
            messagingSenderId: "465007199884",
            appId: "1:465007199884:web:3855e934ea6ec0fddf9da9"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        let peer, localStream, currentCall, myPhone, confirmationResult;

        window.onload = () => {
            const saved = localStorage.getItem('user_data');
            if (saved) {
                const data = JSON.parse(saved);
                myPhone = data.phone;
                initApp(data.name, data.phone);
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
                window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { 'size': 'invisible' });
            }
        };

        function sendOTP() {
            let phone = document.getElementById('country-code').value + document.getElementById('phone-input').value;
            auth.signInWithPhoneNumber(phone, window.recaptchaVerifier).then(result => {
                confirmationResult = result;
                document.getElementById('step-phone').style.display = 'none';
                document.getElementById('step-otp').style.display = 'block';
            }).catch(err => {
                alert("Error: " + err.message);
                location.reload();
            });
        }

        function verifyOTP() {
            const code = document.getElementById('otp-input').value;
            confirmationResult.confirm(code).then(result => {
                myPhone = result.user.phoneNumber;
                checkUser(myPhone);
            }).catch(() => alert("Invalid OTP"));
        }

        function checkUser(phone) {
            db.ref('users/' + phone).once('value', snap => {
                if (snap.exists()) {
                    const user = snap.val();
                    localStorage.setItem('user_data', JSON.stringify({name: user.name, phone: phone}));
                    initApp(user.name, phone);
                } else {
                    document.getElementById('step-otp').style.display = 'none';
                    document.getElementById('step-name').style.display = 'block';
                }
            });
        }

        function registerUser() {
            const name = document.getElementById('username-input').value.trim();
            if (!name) return alert("Enter Username");
            db.ref('usernames').child(name.toLowerCase()).once('value', snap => {
                if (snap.exists()) return alert("Username already taken!");
                db.ref('users/' + myPhone).set({ name: name, status: 'online' });
                db.ref('usernames').child(name.toLowerCase()).set(myPhone);
                localStorage.setItem('user_data', JSON.stringify({name: name, phone: myPhone}));
                initApp(name, myPhone);
            });
        }

        function initApp(name, phone) {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-screen').style.display = 'flex';
            document.getElementById('display-name').innerText = name;
            document.getElementById('display-id').innerText = "ID: " + phone;
            peer = new Peer(phone);
            peer.on('open', () => {
                db.ref('users/' + phone).update({ status: 'online' });
                loadContacts();
            });
            peer.on('call', call => { currentCall = call; showCallUI('incoming', call.peer); });
        }

        function loadContacts() {
            db.ref('users').on('value', snap => {
                const list = document.getElementById('contact-list');
                list.innerHTML = '';
                snap.forEach(child => {
                    if (child.key !== myPhone) {
                        const user = child.val();
                        const div = document.createElement('div');
                        div.className = 'contact-item';
                        div.onclick = () => startCall(child.key);
                        div.innerHTML = `
                            <div class="avatar">${user.name.charAt(0)}</div>
                            <div style="flex:1">
                                <div style="font-weight:bold">${user.name} (${child.key})</div>
                            </div>
                            <div class="status-dot ${user.status === 'online' ? 'online' : 'offline'}"></div>
                        `;
                        list.appendChild(div);
                    }
                });
            });
        }

        function editProfile() {
            const oldName = document.getElementById('display-name').innerText;
            const newName = prompt("New Name:");
            if (newName && newName !== oldName) {
                db.ref('usernames').child(newName.toLowerCase()).once('value', snap => {
                    if (snap.exists()) return alert("Username unavailable");
                    db.ref('usernames').child(oldName.toLowerCase()).remove();
                    db.ref('usernames').child(newName.toLowerCase()).set(myPhone);
                    db.ref('users/' + myPhone).update({ name: newName });
                    localStorage.setItem('user_data', JSON.stringify({name: newName, phone: myPhone}));
                    location.reload();
                });
            }
        }

        function logout() {
            db.ref('users/' + myPhone).update({ status: 'offline' });
            localStorage.clear();
            location.reload();
        }

        async function startCall(target) {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('local-video').srcObject = localStream;
            showCallUI('outgoing', target);
            const call = peer.call(target, localStream);
            setupCallEvents(call);
        }

        function showCallUI(type, id) {
            document.getElementById('call-overlay').style.display = 'flex';
            const controls = document.getElementById('call-ui-controls');
            if (type === 'incoming') {
                document.getElementById('ringtone').play();
                controls.innerHTML = `<button class="btn-round" style="background:green" onclick="answerCall()">Accept</button>
                                      <button class="btn-round" style="background:red" onclick="endCall()">Reject</button>`;
            } else {
                controls.innerHTML = `<button class="btn-round" style="background:red" onclick="endCall()">End</button>`;
            }
        }

        async function answerCall() {
            document.getElementById('ringtone').pause();
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('local-video').srcObject = localStream;
            currentCall.answer(localStream);
            setupCallEvents(currentCall);
        }

        function setupCallEvents(call) {
            currentCall = call;
            call.on('stream', s => document.getElementById('remote-video').srcObject = s);
            call.on('close', endCall);
        }

        function endCall() {
            document.getElementById('ringtone').pause();
            if (currentCall) currentCall.close();
            if (localStream) localStream.getTracks().forEach(t => t.stop());
            document.getElementById('call-overlay').style.display = 'none';
        }

        function toggleDropdown() {
            const m = document.getElementById('profile-menu');
            m.style.display = m.style.display === 'block' ? 'none' : 'block';
        }

        function dialCall() {
            const n = document.getElementById('dial-number').value;
            if (n) startCall(n);
        }
    </script>
</body>
</html>
