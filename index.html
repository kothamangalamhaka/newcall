<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect - Private Video Call</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root { --whatsapp-green: #075e54; --light-green: #25d366; --bg-gray: #ece5dd; --danger: #ff3b30; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-gray); margin: 0; overflow-x: hidden; }
        
        /* Layouts */
        #auth-screen, #main-screen { display: none; height: 100vh; flex-direction: column; }
        .header { background: var(--whatsapp-green); color: white; padding: 15px; font-size: 20px; font-weight: bold; position: sticky; top: 0; z-index: 10; display: flex; justify-content: space-between; align-items: center; }
        .header-btns { display: flex; gap: 10px; }
        .icon-btn { background: none; border: none; color: white; font-size: 14px; cursor: pointer; text-decoration: underline; }

        /* Dialer & Profile */
        .top-section { background: white; padding: 15px; border-bottom: 1px solid #ddd; display: flex; flex-direction: column; gap: 10px; }
        .dialer-container { display: flex; gap: 10px; }
        .dialer-input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; }
        .dialer-btn { background: var(--light-green); border: none; padding: 10px 15px; border-radius: 5px; color: white; font-weight: bold; cursor: pointer; }

        /* Contact List */
        .contact-item { background: white; padding: 15px; border-bottom: 1px solid #ddd; display: flex; align-items: center; cursor: pointer; }
        .avatar { width: 50px; height: 50px; background: #ccc; border-radius: 50%; margin-right: 15px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 20px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; margin-left: auto; }
        .online { background: var(--light-green); }
        .offline { background: #bbb; }

        /* Video Call Overlay */
        #call-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 100; flex-direction: column; }
        .video-container { flex: 1; position: relative; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { width: 100px; height: 140px; position: absolute; top: 20px; right: 20px; border-radius: 10px; border: 2px solid white; object-fit: cover; }
        .call-controls { height: 100px; display: flex; justify-content: center; align-items: center; gap: 30px; background: rgba(0,0,0,0.5); }
        .btn-round { width: 60px; height: 60px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; font-weight: bold; }
        .btn-end { background: var(--danger); }
        .btn-accept { background: var(--light-green); }

        /* Auth Card */
        .auth-card { background: white; padding: 30px; border-radius: 15px; margin: auto; width: 85%; max-width: 380px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; }
        .row { display: flex; gap: 5px; margin: 10px 0; }
        select, input { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; }
        .country-select { width: 100px; }
        .full-input { width: 100%; box-sizing: border-box; }
        .btn-primary { background: var(--light-green); color: white; border: none; padding: 12px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>

    <audio id="ringtone" loop src="https://www.soundjay.com/phone/phone-calling-1.mp3"></audio>

    <div id="auth-screen">
        <div class="auth-card">
            <h2 style="color: var(--whatsapp-green)">Connect</h2>
            <input type="text" id="username" class="full-input" placeholder="‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥™‡µá‡¥∞‡µç">
            <div class="row">
                <select id="country-code" class="country-select">
                    <option value="+966">üá∏üá¶ +966</option>
                    <option value="+91">üáÆüá≥ +91</option>
                    <option value="+971">üá¶üá™ +971</option>
                    <option value="+968">üá¥üá≤ +968</option>
                    <option value="+974">üá∂üá¶ +974</option>
                    <option value="+973">üáßüá≠ +973</option>
                    <option value="+44">üá¨üáß +44</option>
                    <option value="+1">üá∫üá∏ +1</option>
                </select>
                <input type="tel" id="phone" style="flex:1" placeholder="‡¥Æ‡µä‡¥¨‡µà‡µΩ ‡¥®‡¥Æ‡µç‡¥™‡µº">
            </div>
            <button class="btn-primary" onclick="handleLogin()">‡¥§‡µÅ‡¥ü‡¥ô‡µç‡¥ô‡¥æ‡¥Ç</button>
        </div>
    </div>

    <div id="main-screen">
        <div class="header">
            <span>Connect</span>
            <div class="header-btns">
                <button class="icon-btn" onclick="editProfile()">Edit Name</button>
                <button class="icon-btn" style="color: #ffcccc;" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="top-section">
            <div id="welcome-text" style="font-weight: bold; color: var(--whatsapp-green);">‡¥π‡¥≤‡µã...</div>
            <div class="dialer-container">
                <input type="tel" id="dial-number" class="dialer-input" placeholder="‡¥®‡¥Æ‡µç‡¥™‡µº ‡¥ü‡µà‡¥™‡µç‡¥™‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï...">
                <button class="dialer-btn" onclick="dialCall()">Call</button>
            </div>
        </div>

        <div style="padding: 10px; font-size: 14px; color: #666;">‡¥ï‡µã‡µ∫‡¥ü‡¥æ‡¥ï‡µç‡¥±‡µç‡¥±‡µÅ‡¥ï‡µæ</div>
        <div id="contact-list">
            <p style="text-align: center; margin-top: 20px;">‡¥§‡¥ø‡¥∞‡¥Ø‡µÅ‡¥®‡µç‡¥®‡µÅ...</p>
        </div>
    </div>

    <div id="call-overlay">
        <div class="video-container">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay muted playsinline></video>
        </div>
        <div class="call-controls" id="call-ui-controls"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAIowb628afMgDxbAqyoHVpXRfSC_mTL2g",
            authDomain: "fefei-8f083.firebaseapp.com",
            databaseURL: "https://fefei-8f083-default-rtdb.firebaseio.com",
            projectId: "fefei-8f083",
            storageBucket: "fefei-8f083.firebasestorage.app",
            messagingSenderId: "465007199884",
            appId: "1:465007199884:web:3855e934ea6ec0fddf9da9",
            measurementId: "G-1FH5G93YR7"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let peer, localStream, currentCall, myPhone;
        const ringtone = document.getElementById('ringtone');

        window.onload = () => {
            const saved = localStorage.getItem('user_data');
            if (saved) {
                const data = JSON.parse(saved);
                document.getElementById('username').value = data.name;
                myPhone = data.phone;
                initApp(data.name, data.phone);
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
            }
        };

        function handleLogin() {
            const name = document.getElementById('username').value;
            const code = document.getElementById('country-code').value;
            const rawPhone = document.getElementById('phone').value.trim();
            
            if (!name || !rawPhone) return alert("‡¥™‡µá‡¥∞‡µÅ‡¥Ç ‡¥®‡¥Æ‡µç‡¥™‡¥±‡µÅ‡¥Ç ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï");
            
            myPhone = code + rawPhone;
            localStorage.setItem('user_data', JSON.stringify({name, phone: myPhone}));
            initApp(name, myPhone);
        }

        function initApp(name, phone) {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-screen').style.display = 'flex';
            document.getElementById('welcome-text').innerText = "‡¥π‡¥≤‡µã " + name + " (" + phone + ")";

            if (peer) peer.destroy();
            peer = new Peer(phone);

            peer.on('open', (id) => {
                db.ref('users/' + phone).update({ name, status: 'online', lastSeen: Date.now() });
                loadUsers();
            });

            peer.on('call', (call) => {
                currentCall = call;
                showCallUI('incoming', call.peer);
            });
        }

        async function startCamera() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('local-video').srcObject = localStream;
                return true;
            } catch (err) {
                alert("‡¥ï‡µç‡¥Ø‡¥æ‡¥Æ‡¥± ‡¥Ö‡¥®‡µÅ‡¥Æ‡¥§‡¥ø ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï");
                return false;
            }
        }

        function stopCamera() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
        }

        function loadUsers() {
            db.ref('users').on('value', (snapshot) => {
                const list = document.getElementById('contact-list');
                list.innerHTML = '';
                snapshot.forEach((child) => {
                    if (child.key !== myPhone) {
                        const user = child.val();
                        const div = document.createElement('div');
                        div.className = 'contact-item';
                        div.onclick = () => startCall(child.key);
                        div.innerHTML = `
                            <div class="avatar">${user.name.charAt(0).toUpperCase()}</div>
                            <div>
                                <div style="font-weight:bold">${user.name}</div>
                                <div style="font-size:12px; color:#777">${child.key}</div>
                            </div>
                            <div class="status-dot ${user.status === 'online' ? 'online' : 'offline'}"></div>
                        `;
                        list.appendChild(div);
                    }
                });
            });
        }

        function editProfile() {
            const newName = prompt("‡¥™‡µÅ‡¥§‡¥ø‡¥Ø ‡¥™‡µá‡¥∞‡µç ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï:");
            if (newName) {
                const data = JSON.parse(localStorage.getItem('user_data'));
                data.name = newName;
                localStorage.setItem('user_data', JSON.stringify(data));
                db.ref('users/' + myPhone).update({ name: newName });
                document.getElementById('welcome-text').innerText = "‡¥π‡¥≤‡µã " + newName + " (" + myPhone + ")";
            }
        }

        function logout() {
            if (confirm("Logout ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥£‡µã?")) {
                db.ref('users/' + myPhone).update({ status: 'offline' });
                localStorage.removeItem('user_data');
                location.reload();
            }
        }

        function dialCall() {
            const num = document.getElementById('dial-number').value.trim();
            if (num) startCall(num);
            else alert("‡¥®‡¥Æ‡µç‡¥™‡µº ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï");
        }

        async function startCall(targetPhone) {
            const ok = await startCamera();
            if (!ok) return;
            showCallUI('outgoing', targetPhone);
            const call = peer.call(targetPhone, localStream);
            setupCallEvents(call);
        }

        function showCallUI(type, peerId) {
            document.getElementById('call-overlay').style.display = 'flex';
            const controls = document.getElementById('call-ui-controls');
            if (type === 'incoming') {
                ringtone.play();
                controls.innerHTML = `
                    <button class="btn-round btn-accept" onclick="answerCall()">Accept</button>
                    <button class="btn-round btn-end" onclick="rejectCall()">Reject</button>
                `;
            } else {
                controls.innerHTML = `<button class="btn-round btn-end" onclick="endCall()">End Call</button>`;
            }
        }

        async function answerCall() {
            ringtone.pause();
            const ok = await startCamera();
            if (!ok) return rejectCall();
            currentCall.answer(localStream);
            setupCallEvents(currentCall);
        }

        function rejectCall() {
            ringtone.pause();
            if (currentCall) currentCall.close();
            document.getElementById('call-overlay').style.display = 'none';
        }

        function setupCallEvents(call) {
            currentCall = call;
            call.on('stream', (stream) => {
                document.getElementById('remote-video').srcObject = stream;
            });
            call.on('close', endCall);
            call.on('error', endCall);
        }

        function endCall() {
            ringtone.pause();
            if (currentCall) currentCall.close();
            stopCamera();
            document.getElementById('call-overlay').style.display = 'none';
            document.getElementById('remote-video').srcObject = null;
        }
    </script>
</body>
</html>
